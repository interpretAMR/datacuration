---
title: "PublicGenoPheno AllTheBacteria E. coli"
output: html_document
date: "2024-10-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = 'png', echo = TRUE, message = FALSE, warning = FALSE,
                      cache = FALSE, fig.align = 'center')
knitr::opts_knit$set(root.dir = getwd())

# Data wrangling
library(tidyverse)
library(dplyr)
library(patchwork)

source("functions.R")
```

# read AST data - from NCBI
```{r }

ast<-read_delim("Ecoli_AST.tsv.gz") %>% rename(BioSample=`#BioSample`)

length(unique(ast$BioSample))

ast %>% group_by(BioSample) %>% summarise(n=length(unique((Antibiotic))))%>% pull(n) %>% summary()

```

# read ATB AMRfinderplus calls
```{r }

afp <-read_tsv("ATB_Ecoli_AFP.tsv.gz")
gene_counts <- afp %>% group_by(`Gene symbol`, Class, Subclass) %>% count()

species_calls <- read_tsv("species_calls.tsv.gz")
ecoli <- species_calls %>% filter(Species=="Escherichia coli") %>% pull(Sample)

afp_status <- read_tsv("AMRFP_status.tsv.gz") %>% filter(sample %in% ecoli)
denominator <- afp_status %>% filter(status=="PASS") %>% nrow()
```

# get AMRfinderplus and AST data where both are available
``` {r}
sum(unique(ast$BioSample) %in% afp$Name)

# AST data for strains with AMRfinder run successfully
ast_matched <- ast %>% filter(BioSample %in% afp_status$sample[afp_status$status=="PASS"])

# AMRfinder results, for strains with matching AST data from NCBI
afp_matched <- afp %>% filter(Name %in% ast$BioSample)

# check objects
dim(ast_matched)
ast_matched %>% pull(BioSample) %>% unique() %>% length()

dim(afp_matched)
afp_matched %>% pull(Name) %>% unique() %>% length()
```

# frequency of common core-gene mutations
``` {r}

# number with pmrB_Y358N
(gene_counts %>% filter(`Gene symbol`=="pmrB_Y358N") %>% pull(n))/denominator
  
# number with glpT_E448K 
(gene_counts %>% filter(`Gene symbol`=="glpT_E448K") %>% pull(n))/denominator

```

# solo markers for ceftriaxone
``` {r}

cef_cephalosporin <- solo_marker_atb(ast_matched = ast_matched, afp_matched=afp_matched, antibiotic = "ceftriaxone", refgene_subclass = "CEPHALOSPORIN")

cef_cephalosporin$solo_stats
cef_cephalosporin$combined_plot
```

# solo markers for fosfomycin
``` {r}
fos_fosfomycin <- solo_marker_atb(ast_matched = ast_matched, antibiotic="fosfomycin", refgene_subclass="FOSFOMYCIN", afp_matched=afp_matched)

fos_fosfomycin$solo_stats

fos_fosfomycin$combined_plot

```


# solo markers for colistin
``` {r}
colistin <- solo_marker_atb(ast_matched = ast_matched, antibiotic="colistin", refgene_subclass="COLISTIN", afp_matched=afp_matched)

colistin$solo_stats

colistin$combined_plot

```

# solo markers for ceftriaxone
``` {r}
cef_cephalosporin <- solo_marker_atb(ast_matched = ast_matched, antibiotic="ceftriaxone", refgene_subclass="CEPHALOSPORIN", afp_matched=afp_matched)

cef_cephalosporin$solo_stats

cef_cephalosporin$combined_plot
```

# solo markers for gentamicin vs aminoglycosides
``` {r}
gentamicin_agly <- solo_marker_atb(ast_matched = ast_matched, antibiotic="gentamicin", refgene_class="AMINOGLYCOSIDE", afp_matched=afp_matched)

gentamicin_agly$solo_stats

gentamicin_agly$combined_plot
```

# solo markers for amikacin vs aminoglycosides
``` {r}
amikacin_agly <- solo_marker_atb(ast_matched = ast_matched, antibiotic="amikacin", refgene_class="AMINOGLYCOSIDE", afp_matched=afp_matched)

amikacin_agly$solo_stats

amikacin_agly$combined_plot
```

# solo markers for tobramycin vs aminoglycosides
``` {r}
tobramycin_agly <- solo_marker_atb(ast_matched = ast_matched, antibiotic="tobramycin", refgene_class="AMINOGLYCOSIDE", afp_matched=afp_matched)

tobramycin_agly$solo_stats

tobramycin_agly$combined_plot
```
# solo markers for ampicillin
``` {r}
ampicillin <- solo_marker_atb(ast_matched = ast_matched, antibiotic="ampicillin", refgene_class="BETA-LACTAM", afp_matched=afp_matched)

ampicillin$solo_stats

ampicillin$combined_plot
```
# solo markers for azithromycin
``` {r}
azi <- solo_marker_atb(ast_matched = ast_matched, antibiotic="azithromycin", refgene_subclass="AZITHROMYCIN", afp_matched=afp_matched)

azi$solo_stats

azi$combined_plot
```

# solo markers for imipenem
``` {r}
imipenem <- solo_marker_atb(ast_matched = ast_matched, antibiotic="imipenem", refgene_subclass="CARBAPENEM", afp_matched=afp_matched)

imipenem$solo_stats

imipenem$combined_plot
```

# solo markers for meropenem
``` {r}
meropenem <- solo_marker_atb(ast_matched = ast_matched, antibiotic="meropenem", refgene_subclass="CARBAPENEM", afp_matched=afp_matched)

meropenem$solo_stats

meropenem$combined_plot
```

# solo markers for ceftazidime
``` {r}
ceftazidime_cephalosporin <- solo_marker_atb(ast_matched = ast_matched, antibiotic="ceftazidime", refgene_subclass="CEPHALOSPORIN", afp_matched=afp_matched)

ceftazidime_cephalosporin$solo_stats

ceftazidime_cephalosporin$combined_plot
```

# solo markers for chloramphenicol
``` {r}
chloramphenicol <- solo_marker_atb(ast_matched = ast_matched, antibiotic="chloramphenicol", refgene_class="PHENICOL", afp_matched=afp_matched)

chloramphenicol$solo_stats

chloramphenicol$combined_plot
```

# solo markers for trimethoprim
``` {r}
trimethoprim <- solo_marker_atb(ast_matched = ast_matched, antibiotic="trimethoprim-sulfamethoxazole", refgene_subclass="TRIMETHOPRIM", afp_matched=afp_matched)

trimethoprim$solo_stats

trimethoprim$combined_plot
```

# solo markers for tetracycline
``` {r}
tet <- solo_marker_atb(ast_matched = ast_matched, antibiotic="tetracycline", refgene_class="TETRACYCLINE", afp_matched=afp_matched)

tet$solo_stats

tet$combined_plot
```

# solo markers for tigecycline
``` {r}
tig <- solo_marker_atb(ast_matched = ast_matched, antibiotic="tigecycline", refgene_subclass="TIGECYCLINE", afp_matched=afp_matched)

tig$solo_stats

```

# solo markers for ciprofloxacin
``` {r}
cip <- solo_marker_atb(ast_matched = ast_matched, antibiotic="ciprofloxacin", refgene_subclass="QUINOLONE", afp_matched=afp_matched)

cip$solo_stats

cip$combined_plot
```